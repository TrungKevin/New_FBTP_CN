rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function signedIn() {
      return request.auth != null;
    }
    
    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }
    
    function isFieldOwner(fieldId) {
      return signedIn() && 
        get(/databases/$(db)/documents/fields/$(fieldId)).data.ownerId == request.auth.uid;
    }

    // USERS
    match /users/{uid} {
      allow create: if isSelf(uid);
      allow read: if true;
      allow update, delete: if isSelf(uid);
    }

    // FIELDS
    match /fields/{fieldId} {
      allow read: if true;
      allow create: if signedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if signedIn() && request.resource.data.ownerId == request.auth.uid;
      allow delete: if signedIn() && resource.data.ownerId == request.auth.uid;
    }

    // PRICING_RULES
    match /pricing_rules/{ruleId} {
      allow read: if true;
      allow create: if signedIn() &&
        request.resource.data.fieldId != null &&
        isFieldOwner(request.resource.data.fieldId);
      allow update, delete: if signedIn() &&
        resource.data.fieldId != null &&
        isFieldOwner(resource.data.fieldId);
    }

    // FIELD_SERVICES
    match /field_services/{fsId} {
      allow read: if true;
      allow create: if signedIn() &&
        request.resource.data.fieldId != null &&
        isFieldOwner(request.resource.data.fieldId);
      allow update, delete: if signedIn() &&
        resource.data.fieldId != null &&
        isFieldOwner(resource.data.fieldId);
    }

    // MATCHES
    match /matches/{matchId} {
      allow read: if true;

      allow create: if signedIn() &&
        request.resource.data.participants != null &&
        request.resource.data.participants.size() > 0 &&
        request.resource.data.participants[0].renterId == request.auth.uid;

      allow update: if signedIn() && (
        (resource.data.participants != null && (
          resource.data.participants[0].renterId == request.auth.uid ||
          (resource.data.participants.size() > 1 && resource.data.participants[1].renterId == request.auth.uid)
        )) ||
        (request.resource.data.participants != null &&
          request.resource.data.participants.size() > 1 &&
          request.resource.data.participants[1].renterId == request.auth.uid) ||
        isFieldOwner(resource.data.fieldId)
      );

      allow delete: if signedIn() && isFieldOwner(resource.data.fieldId);
    }
      
    // MATCH_RESULTS
    match /match_results/{resultId} {
      allow read: if true;

      allow create: if signedIn() &&
        request.resource.data.fieldId != null &&
        request.resource.data.matchId != null && (
          isFieldOwner(request.resource.data.fieldId) ||
          (
            get(/databases/$(db)/documents/matches/$(request.resource.data.matchId)).data.participants.size() > 0 &&
            (
              get(/databases/$(db)/documents/matches/$(request.resource.data.matchId)).data.participants[0].renterId == request.auth.uid ||
              (
                get(/databases/$(db)/documents/matches/$(request.resource.data.matchId)).data.participants.size() > 1 &&
                get(/databases/$(db)/documents/matches/$(request.resource.data.matchId)).data.participants[1].renterId == request.auth.uid
              )
            )
          )
        );

      allow update, delete: if signedIn() &&
        resource.data.fieldId != null &&
        isFieldOwner(resource.data.fieldId);
    }

    // BOOKINGS
    match /bookings/{bookingId} {
      allow read: if true;
      allow create: if signedIn() && request.resource.data.renterId == request.auth.uid;
      allow update, delete: if signedIn() &&
        (resource.data.renterId == request.auth.uid || isFieldOwner(resource.data.fieldId));
    }

    // SLOTS
    match /slots/{slotId} {
      allow read: if true;
      allow create: if signedIn() &&
        request.resource.data.fieldId != null &&
        isFieldOwner(request.resource.data.fieldId);
      allow update, delete: if signedIn() &&
        resource.data.fieldId != null &&
        isFieldOwner(resource.data.fieldId);
    }

    // REVIEWS - ✅ SỬA LỖI INDEX
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if signedIn() && request.resource.data.renterId == request.auth.uid;
      allow update, delete: if signedIn() &&
        (resource.data.renterId == request.auth.uid || isFieldOwner(resource.data.fieldId));
    }

    // REPLIES - ✅ SỬA LỖI INDEX (Đúng path structure)
    match /reviews/{reviewId}/replies/{replyId} {
      allow read: if true;
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() &&
        (resource.data.userId == request.auth.uid ||
         isFieldOwner(get(/databases/$(db)/documents/reviews/$(reviewId)).data.fieldId));
    }

    // NOTIFICATIONS - ✅ HỖ TRỢ ĐẦY ĐỦ CHO OWNER VÀ RENTER
    match /notifications/{notificationId} {
      // Đọc/cập nhật/xóa: chỉ người nhận
      allow read, update, delete: if signedIn() && resource.data.toUserId == request.auth.uid;

      // Tạo: cho phép khi:
      // 1. toUserId là owner của fieldId (renter→owner notifications)
      // 2. Người tạo là owner của fieldId (owner→renter notifications)  
      // 3. System notifications (không có fieldId) - cho phép tất cả user đã đăng nhập
      allow create: if signedIn() && (
        // Trường hợp có fieldId: kiểm tra ownership
        (request.resource.data.data != null && 
         request.resource.data.data.fieldId != null && (
           // Renter gửi notification cho Owner
           get(/databases/$(db)/documents/fields/$(request.resource.data.data.fieldId)).data.ownerId
             == request.resource.data.toUserId ||
           // Owner gửi notification cho Renter
           get(/databases/$(db)/documents/fields/$(request.resource.data.data.fieldId)).data.ownerId
             == request.auth.uid
         )) ||
        // Cho phép renter gửi notification cho renter khác khi đã ghép đối thủ (OPPONENT_MATCHED)
        (
          request.resource.data.type == "OPPONENT_MATCHED" &&
          request.resource.data.data != null && request.resource.data.data.matchId != null &&
          (
            // Người tạo phải là 1 trong 2 participants của match
            (
              get(/databases/$(db)/documents/matches/$(request.resource.data.data.matchId)).data.participants.size() > 0 &&
              (
                get(/databases/$(db)/documents/matches/$(request.resource.data.data.matchId)).data.participants[0].renterId == request.auth.uid ||
                (
                  get(/databases/$(db)/documents/matches/$(request.resource.data.data.matchId)).data.participants.size() > 1 &&
                  get(/databases/$(db)/documents/matches/$(request.resource.data.data.matchId)).data.participants[1].renterId == request.auth.uid
                )
              )
            )
          )
        ) ||
        // Cho phép broadcast khi có người chờ đối thủ
        (request.resource.data.type == "OPPONENT_AVAILABLE") ||
        // Cho phép booking confirmation notifications (owner confirms booking)
        (request.resource.data.type == "BOOKING_CONFIRMED" &&
         request.resource.data.data != null && 
         request.resource.data.data.fieldId != null &&
         get(/databases/$(db)/documents/fields/$(request.resource.data.data.fieldId)).data.ownerId == request.auth.uid) ||
        // Trường hợp không có fieldId: system notifications (OPPONENT_AVAILABLE)
        (request.resource.data.data == null || 
         request.resource.data.data.fieldId == null)
      );
    }

    // USER_DEVICES
    match /user_devices/{deviceId} {
      allow read: if signedIn() && resource.data.userId == request.auth.uid;
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.userId == request.auth.uid;
    }
  }
}