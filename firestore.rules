rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function signedIn() {
      return request.auth != null;
    }
    
    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }
    
    function isFieldOwner(fieldId) {
      return signedIn() && 
        get(/databases/$(db)/documents/fields/$(fieldId)).data.ownerId == request.auth.uid;
    }

    // USERS
    match /users/{uid} {
      allow create: if isSelf(uid);
      allow read: if true;
      allow update, delete: if isSelf(uid);
    }

    // FIELDS
    match /fields/{fieldId} {
      allow read: if true;
      allow create: if signedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if signedIn() && request.resource.data.ownerId == request.auth.uid;
      allow delete: if signedIn() && resource.data.ownerId == request.auth.uid;
    }

    // PRICING_RULES
    match /pricing_rules/{ruleId} {
      allow read: if true;
      allow create: if signedIn() &&
        request.resource.data.fieldId != null &&
        isFieldOwner(request.resource.data.fieldId);
      allow update, delete: if signedIn() &&
        resource.data.fieldId != null &&
        isFieldOwner(resource.data.fieldId);
    }

    // FIELD_SERVICES
    match /field_services/{fsId} {
      allow read: if true;
      allow create: if signedIn() &&
        request.resource.data.fieldId != null &&
        isFieldOwner(request.resource.data.fieldId);
      allow update, delete: if signedIn() &&
        resource.data.fieldId != null &&
        isFieldOwner(resource.data.fieldId);
    }

    // MATCHES
    match /matches/{matchId} {
      allow read: if true;

      allow create: if signedIn() &&
        request.resource.data.participants != null &&
        request.resource.data.participants.size() > 0 &&
        request.resource.data.participants[0].renterId == request.auth.uid;

      allow update: if signedIn() && (
        (resource.data.participants != null && (
          resource.data.participants[0].renterId == request.auth.uid ||
          (resource.data.participants.size() > 1 && resource.data.participants[1].renterId == request.auth.uid)
        )) ||
        (request.resource.data.participants != null &&
          request.resource.data.participants.size() > 1 &&
          request.resource.data.participants[1].renterId == request.auth.uid) ||
        isFieldOwner(resource.data.fieldId)
      );

      allow delete: if signedIn() && isFieldOwner(resource.data.fieldId);
    }
      
    // MATCH_RESULTS
    match /match_results/{resultId} {
      allow read: if true;

      allow create: if signedIn() &&
        request.resource.data.fieldId != null &&
        request.resource.data.matchId != null && (
          isFieldOwner(request.resource.data.fieldId) ||
          (
            get(/databases/$(db)/documents/matches/$(request.resource.data.matchId)).data.participants.size() > 0 &&
            (
              get(/databases/$(db)/documents/matches/$(request.resource.data.matchId)).data.participants[0].renterId == request.auth.uid ||
              (
                get(/databases/$(db)/documents/matches/$(request.resource.data.matchId)).data.participants.size() > 1 &&
                get(/databases/$(db)/documents/matches/$(request.resource.data.matchId)).data.participants[1].renterId == request.auth.uid
              )
            )
          )
        );

      allow update, delete: if signedIn() &&
        resource.data.fieldId != null &&
        isFieldOwner(resource.data.fieldId);
    }

    // BOOKINGS (support single renterId or two participants renterA/renterB)
    match /bookings/{bookingId} {
      allow read: if signedIn() && (
        // single renter schema
        (resource.data.renterId != null && resource.data.renterId == request.auth.uid) ||
        // two participants schema
        (resource.data.renterA != null && resource.data.renterA == request.auth.uid) ||
        (resource.data.renterB != null && resource.data.renterB == request.auth.uid) ||
        isFieldOwner(resource.data.fieldId)
      );
      allow create: if signedIn() && (
        (request.resource.data.renterId != null && request.resource.data.renterId == request.auth.uid) ||
        (request.resource.data.renterA != null && request.resource.data.renterA == request.auth.uid) ||
        (request.resource.data.renterB != null && request.resource.data.renterB == request.auth.uid)
      );
      allow update, delete: if signedIn() && (
        (resource.data.renterId != null && resource.data.renterId == request.auth.uid) ||
        (resource.data.renterA != null && resource.data.renterA == request.auth.uid) ||
        (resource.data.renterB != null && resource.data.renterB == request.auth.uid) ||
        isFieldOwner(resource.data.fieldId)
      );
    }

    // SLOTS - owner full control; renter may update status available->booked only
    match /slots/{slotId} {
      allow read: if true;
      allow create: if signedIn() &&
        request.resource.data.fieldId != null &&
        isFieldOwner(request.resource.data.fieldId);
      allow update: if signedIn() && (
        (resource.data.fieldId != null && isFieldOwner(resource.data.fieldId)) ||
        (
          // renter can only toggle status from available to booked
          request.resource.data.diff(resource.data).changedKeys().hasOnly(["status"]) &&
          resource.data.status == "available" &&
          request.resource.data.status == "booked"
        )
      );
      allow delete: if signedIn() && resource.data.fieldId != null && isFieldOwner(resource.data.fieldId);
    }

    // Leaderboards (bảng xếp hạng theo sân)
    match /leaderboards/{fieldId} {
      allow read: if true;
      allow create, update, delete: if signedIn() && isFieldOwner(fieldId);
      allow create, update: if signedIn() && isFieldOwner(fieldId) &&
        request.resource.data.fieldId == fieldId &&
        request.resource.data.updatedAt is int &&
        request.resource.data.entries is list;
    }

    // MATCH_REQUESTS
    match /match_requests/{requestId} {
      // create by one of participants
      allow create: if signedIn() && (
        request.resource.data.renterA == request.auth.uid ||
        request.resource.data.renterB == request.auth.uid
      );
      // view by participants or field owner
      allow read: if signedIn() && (
        resource.data.renterA == request.auth.uid ||
        resource.data.renterB == request.auth.uid ||
        isFieldOwner(resource.data.fieldId)
      );
      allow update, delete: if signedIn() && (
        resource.data.renterA == request.auth.uid ||
        resource.data.renterB == request.auth.uid ||
        isFieldOwner(resource.data.fieldId)
      );
    }

    // UPPERCASE alias support (for legacy code paths)
    match /BOOKING/{bookingId} {
      allow read, create, update, delete: if matches(/databases/$(db)/documents/bookings/$(bookingId));
    }
    match /TIME_SLOT/{slotId} {
      allow read, create, update, delete: if matches(/databases/$(db)/documents/slots/$(slotId));
    }
    match /MATCH_REQUEST/{requestId} {
      allow read, create, update, delete: if matches(/databases/$(db)/documents/match_requests/$(requestId));
    }

    // REVIEWS - ✅ SỬA LỖI INDEX
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if signedIn() && request.resource.data.renterId == request.auth.uid;
      allow update, delete: if signedIn() &&
        (resource.data.renterId == request.auth.uid || isFieldOwner(resource.data.fieldId));
    }

    // REPLIES - ✅ SỬA LỖI INDEX (Đúng path structure)
    match /reviews/{reviewId}/replies/{replyId} {
      allow read: if true;
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() &&
        (resource.data.userId == request.auth.uid ||
         isFieldOwner(get(/databases/$(db)/documents/reviews/$(reviewId)).data.fieldId));
    }

    // NOTIFICATIONS - ✅ HỖ TRỢ ĐẦY ĐỦ CHO OWNER VÀ RENTER
    match /notifications/{notificationId} {
      // Đọc/cập nhật/xóa: chỉ người nhận
      allow read, update, delete: if signedIn() && resource.data.toUserId == request.auth.uid;

      // Tạo: cho phép khi:
      // 1. toUserId là owner của fieldId (renter→owner notifications)
      // 2. Người tạo là owner của fieldId (owner→renter notifications)  
      // 3. System notifications (không có fieldId) - cho phép tất cả user đã đăng nhập
      allow create: if signedIn() && (
        // Trường hợp có fieldId: kiểm tra ownership
        (request.resource.data.data != null && 
         request.resource.data.data.fieldId != null && (
           // Renter gửi notification cho Owner
           get(/databases/$(db)/documents/fields/$(request.resource.data.data.fieldId)).data.ownerId
             == request.resource.data.toUserId ||
           // Owner gửi notification cho Renter
           get(/databases/$(db)/documents/fields/$(request.resource.data.data.fieldId)).data.ownerId
             == request.auth.uid
         )) ||
        // Cho phép thông báo thách đấu renter ↔ renter (dữ liệu có thể ở root hoặc trong data.customData)
        (
          (request.resource.data.type in ["MATCH_INVITE", "MATCH_ACCEPTED", "MATCH_REJECTED"]) &&
          request.resource.data.toUserId != null &&
          (
            request.resource.data.inviteId != null ||
            (request.resource.data.data != null && request.resource.data.data.customData != null && request.resource.data.data.customData.inviteId != null)
          ) &&
          (
            request.resource.data.fromRenterId == request.auth.uid ||
            request.resource.data.toRenterId == request.auth.uid ||
            (request.resource.data.data != null && request.resource.data.data.customData != null && (
              request.resource.data.data.customData.fromRenterId == request.auth.uid ||
              request.resource.data.data.customData.toRenterId == request.auth.uid
            ))
          )
        ) ||
        // Cho phép renter gửi notification cho renter khác khi đã ghép đối thủ (OPPONENT_MATCHED)
        (
          request.resource.data.type == "OPPONENT_MATCHED" &&
          request.resource.data.data != null && request.resource.data.data.matchId != null &&
          (
            // Người tạo phải là 1 trong 2 participants của match
            (
              get(/databases/$(db)/documents/matches/$(request.resource.data.data.matchId)).data.participants.size() > 0 &&
              (
                get(/databases/$(db)/documents/matches/$(request.resource.data.data.matchId)).data.participants[0].renterId == request.auth.uid ||
                (
                  get(/databases/$(db)/documents/matches/$(request.resource.data.data.matchId)).data.participants.size() > 1 &&
                  get(/databases/$(db)/documents/matches/$(request.resource.data.data.matchId)).data.participants[1].renterId == request.auth.uid
                )
              )
            )
          )
        ) ||
        // Cho phép broadcast khi có người chờ đối thủ
        (request.resource.data.type == "OPPONENT_AVAILABLE") ||
        // Cho phép booking confirmation notifications (owner confirms booking)
        (request.resource.data.type == "BOOKING_CONFIRMED" &&
         request.resource.data.data != null && 
         request.resource.data.data.fieldId != null &&
         get(/databases/$(db)/documents/fields/$(request.resource.data.data.fieldId)).data.ownerId == request.auth.uid) ||
        // Cho phép booking cancellation notifications (owner cancels booking)
        (request.resource.data.type == "BOOKING_CANCELLED_BY_OWNER" &&
         request.resource.data.data != null && 
         request.resource.data.data.fieldId != null &&
         get(/databases/$(db)/documents/fields/$(request.resource.data.data.fieldId)).data.ownerId == request.auth.uid) ||
        // Trường hợp không có fieldId: system notifications (OPPONENT_AVAILABLE)
        (request.resource.data.data == null || 
         request.resource.data.data.fieldId == null)
      );
    }

    // MATCH_INVITES - lời mời thách đấu renter ↔ renter
    match /match_invites/{inviteId} {
      // Tạo bởi người gửi
      allow create: if signedIn() && request.resource.data.fromRenterId == request.auth.uid;
      // Đọc bởi hai bên
      allow read: if signedIn() && (
        resource.data.fromRenterId == request.auth.uid ||
        resource.data.toRenterId == request.auth.uid
      );
      // Cập nhật trạng thái bởi hai bên (ví dụ: accepted/rejected)
      allow update: if signedIn() && (
        resource.data.fromRenterId == request.auth.uid ||
        resource.data.toRenterId == request.auth.uid
      );
      // Không cho xóa để lưu lịch sử
    }

    // USER_DEVICES
    match /user_devices/{deviceId} {
      allow read: if signedIn() && resource.data.userId == request.auth.uid;
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.userId == request.auth.uid;
    }
  }
}